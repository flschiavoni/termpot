/**
 * @file   : Ptty.jquery.js
 * @ver    : 0.0.3
 * @Author : Patxi Pierce
 * @url    : http://code.patxipierce.com/jquery-plugin/ptty/
 * @desc   : Ptty (Pachanka's teletype). A terminal emulator plugin for jQuery. 
 * @note   : Based on wterm.js by Venkatakrishnan Ganesh.
 * @license: Copyright 2014 Patxi Pierce <mail@patxipierce.com>
 *           This work is free. You can redistribute it and/or modify it under the
 *           terms of the Do What The Fuck You Want To Public License, Version 2,
 *           as published by Sam Hocevar. See the COPYING file for more details.
 *
 * */
!function(t){var e="0.0.3",n=function(){return{url:window.location.pathname,method:"POST",param:"cmd",tty_class:"cmd_terminal",ps:"",theme:"boring",width:"100%",height:"100%",welcome:"Ptty v."+e,placeholder:"*",not_found:"<div> CMD: Command Not Found </div>",error_prefix:"An Error Occured: ",autocomplete:!0,history:!0,history_max:800,charset:"UTF-8",enctype:"multipart/form-data",autofocus:!0}},s={},a={},l=[],o={cmd_name:null,cmd_class:null,cmd_ps:null,cmd_in:null,cmd_out:null,cmd_quiet:null,cmd_token:null,cmd_query:null},c=function(e){var a=n();t.extend(!0,a,e),t.register_command("clear","Cleans the screen leaving a new command prompt ready.","clear [no options]",function(){return t("."+a.tty_class+"_content").html(""),{type:"print",out:"",quiet:"clear"}}),t.register_command("history","Shows list of typed in commands.","history [no options]",function(){var t="";if(a.history&&l.length>0){var e,n;for(e in l)n=l[e],t+="<li>"+n+"</li>";t='<ul class="ve-li">'+t+"</ul>"}return{type:"print",out:t}}),t.register_command("help","Displays a list of useful information.","help [ [-a | --all] | [command] ]",function(e){var n="";if("string"==typeof e[1]&&e[1].length>0){var a=t.trim(e[1]);if("-a"==a||"--all"==a){n='Available commands are:</br><ul class="ve-li">';for(i in s)n+="<li><p><b>"+i+"</b> - "+s[i].desc+"</br>",n+="Usage: "+s[i].usage+"</p></li>";n+="</ul>\n"}else"undefined"!=typeof s[a]?(n="<b>"+a+"</b> - "+s[a].desc+"</br>",n+="Usage: "+s[a].usage+"\n"):n='help:</br>The "'+a+'" option does not exist.\n'}else{n='Use "help [comand name]" to display specific info about a command.</br>\n',n+='Available commands are:</br><ul class="sq-li">';for(i in s)n+="<li>"+i+"</li>";n+="</ul>\n"}return{type:"print",out:n}})};t.fn.Ptty=function(e){var u=n();return t.extend(!0,u,e),this.each(function(){var n=t(this),r=null;n.addClass(u.tty_class).addClass(u.tty_class+"_theme_"+u.theme),u.width&&u.height&&n.css({width:u.width,height:u.height}),n.html("").append('<div class="'+u.tty_class+'_loading"><span></span></div><div class="'+u.tty_class+'_content"><div>'+u.welcome+'</div></div><div class="'+u.tty_class+'_prompt"><span class="'+u.tty_class+'_ps"><span class="'+u.tty_class+'_active">'+u.ps+'</span>&nbsp;</span><form accept-charset="'+u.charset+'" enctype="'+u.enctype+'"><input type="text" autocomplete="off" /><input type="password" /><span class="upl_container hide"><input type="file" /><a href="javascript:void(0)" onclick="$(this).parent().addClass(\'hide\').siblings(\'input[type=text]\').show();">Cancel</a></span></form><progress class="'+u.tty_class+'_progress"></progress></div>');var d=n.find("span."+u.tty_class+"_active"),p=n.find("div:last form"),f=(p.find("input"),p.find("input[type=text]")),_=p.find("input[type=password]"),m=p.find("input[type=file]"),h=n.find("div."+u.tty_class+"_content"),y=n.find("div."+u.tty_class+"_loading"),v=null,g={ac_save:null,h_save:null};u.autofocus&&f.focus(),n.bind("select focus click",function(){f.is(":visible")?f.focus():_.is(":visible")&&_.focus()}),d.removeAttr("disabled"),c(e);var b=function(t,e,n){var s=o.cmd_class;null===s&&(s=v?u.tty_class+"_sub":u.tty_class+"_ps"),null!==o.cmd_in&&(e=o.cmd_in),null!==o.cmd_out&&(n=o.cmd_out),"clear"==o.cmd_quiet?(h.html(""),t=""):"password"==o.cmd_quiet?(e=Array(e.length+1).join(u.placeholder),t='<span class="'+s+'"><span>'+t+"</span>&nbsp;"+e+"</span>"):t="blank"==o.cmd_quiet?'<span class="'+s+'"><span>'+t+"</span>&nbsp;</span>":"output"==o.cmd_quiet?"":'<span class="'+s+'"><span>'+t+"</span>&nbsp;"+e+"</span>",h.append("<div>"+t+"<div>"+n+"</div></div>"),y.fadeOut(300),d.removeAttr("disabled").show()},w=function(){var t=v?v.ps:u.ps;return null!==o.cmd_ps?o.cmd_ps:t},k=function(t){return null===o.cmd_class&&(o.cmd_class=v?u.tty_class+"_sub":u.tty_class+"_ps"),null===t&&(t=v?v.ps:u.ps),d.html(t),t},q=function(e,n,a){var l={cmd:n};null!==o.cmd_query&&(l.cmd_query=o.cmd_query),null!==o.cmd_in&&(l.cmd=o.cmd_in),null!==o.cmd_token&&(l.cmd_token=o.cmd_token),(a===!1||""==a||"undefined"==typeof a)&&(a=s[e].type_of?s[e].type_of:u.url),t.ajax({type:u.method,url:a,data:l}).done(function(t){t.ajax_url=a,t=t||"",S(n,t)}).fail(function(){b(w(),n,"<div>"+u.error_prefix+" Invalid server response. </div>")})},x=function(t,e,n,a){""==t?b(w(),e,""):null!==v?D(t,e,n):"undefined"==typeof s[t]?b(w(),e,u.not_found.replace("CMD",n[0])):"object"==typeof s[t].type_of?D(t,e,n):"string"==typeof s[t].type_of?q(t,e,a):"function"==typeof s[t].type_of?A(s[t].type_of,n,e):q(t,e,u.url)},C=function(t){v=s[t].type_of,d.html(v.ps),n.find("div:last span:first").toggleClass(u.tty_class+"_ps "+u.tty_class+"_sub"),o.cmd_name=t,o.cmd_ps=u.ps,o.cmd_class=u.tty_class+"_ps",g.ac_save=u.autocomplete,u.autocomplete=!1,g.h_save=l,l=[]},j=function(){d.html(""),n.find("div:last span:first").toggleClass(u.tty_class+"_ps "+u.tty_class+"_sub"),o.cmd_ps=null!==o.cmd_ps?o.cmd_ps:v.ps,o.cmd_class=u.tty_class+"_sub",o.cmd_name=null,o.cmd_token=null,o.cmd_query=null,u.autocomplete=g.ac_save?g.ac_save:!1,l=g.h_save?g.h_save:[],v=null},D=function(t,e,n){var s=u.url;null==v?(C(t),s=v.start_hook):v&&("quit"==t||"exit"==t?(s=v.exit_hook,j()):s=v.dispatch_method),"string"==typeof s?q(t,e,s):"function"==typeof s&&A(s,n,e)},A=function(t,e,n){return S(n,t(e))},S=function(t,e){e=e||"";var n={ps:w(),output:""};switch(e.type){case"prompt":if(!o.cmd_token){var s=Math.random().toString(36).substr(2),l=Math.random().toString(36).substr(2),i=Math.random().toString(36).substr(2);o.cmd_token=s+l+i}break;case"password":f.hide(),_.show().focus();break;case"upload":"undefined"!=typeof e.upload_multiple&&m.attr("multiple","multiple"),"undefined"!=typeof e.upload_accept&&m.attr("accept",e.upload_accept),f.hide(),m.parent().removeClass("hide"),m.bind("change",function(){m.parent().addClass("hide"),f.show(),""!=m.val()&&O(this.files,e),m.attr("accept",""),m.attr("multiple",""),m.val("")});break;default:e.type="print"}if(("exit"==t||"quit"==t)&&(n.ps=o.cmd_ps,o.cmd_ps=null),o.cmd_ps="undefined"!=typeof e.ps?k(e.ps):null,"undefined"!=typeof e.class&&(o.cmd_class=e.class),"undefined"!=typeof e.in&&(o.cmd_in=e.in),"undefined"!=typeof e.out&&(n.output=o.cmd_out=e.out),"undefined"!=typeof e.quiet&&(o.cmd_quiet=e.quiet),"undefined"!=typeof e.token&&(o.cmd_token=e.token),"undefined"!=typeof e.query&&(o.cmd_query=e.query),b(n.ps,t,n.output),"undefined"!=typeof e.exit&&v&&(j(),o.cmd_ps=null),"undefined"!=typeof e.callback)try{if("function"!=typeof a[e.callback])throw u.error_prefix+" "+e.callback+" callback unknown.";n.output=a[e.callback](e)}catch(c){}},T=function(){var t=0,e=new_height=n.height(),s=setInterval(function(){e!=new_height?(clearInterval(s),n.animate({scrollTop:new_height},"slow")):t>=30?(clearInterval(s),n.animate({scrollTop:new_height},"slow")):(new_height=h.height(),t++)},50)},M=function(e){if(e.lengthComputable){var n=t("."+u.tty_class+"_progress");n.attr({value:e.loaded,max:e.total})}},O=function(e,n){var s="",a=t("."+u.tty_class+"_progress");if("undefined"!=typeof n.upload_to)var l=n.upload_to;else var l=null!==v?v.dispatch_method:u.url;for(var o=new FormData,i=0;i<e.length;i++)o.append("file_"+i,e[i]),s+=" "+e[i].name;for(var c in n)o.append(c,n[c]);a.show(),t.ajax({url:l,type:"POST",xhr:function(){var e=t.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",M,!1),e},data:o,cache:!1,contentType:!1,processData:!1}).done(function(t){console.log("Uploaded:"+s+" to "+l),console.log(t)}).fail(function(){console.log("Error uploading.")}).always(function(){a.hide()})};p.submit(function(e){e.preventDefault(),e.stopPropagation();var n=f.val(),a=" "==n.charAt(0)?!1:!0;n=t.trim(t("<div/>").text(n).html()),_.val().length&&(n=_.val(),_.val("")),m.val().length&&(n=m.val(),m.val(""));for(opt in o)"cmd_name"!==opt&&"cmd_ps"!==opt&&"cmd_query"!==opt&&"cmd_token"!==opt&&(o[opt]=null);o.cmd_in=n,null!==o.cmd_query&&(n=o.cmd_query+n);var i=n.split(/\s+/),c=i[0];u.history&&("undefined"!=typeof s[c]||v)&&a&&n.length&&null===o.cmd_quiet&&(l.length>u.history_entries&&l.shift(),l.push(t.trim(t("<div/>").html(n).text()))),r=0,y.show(),d.attr("disabled","disabled").hide(),x(c,n,i),f.val(""),f.focus(),T()}),f.keydown(function(e){var n=e.keyCode;switch(n){case 9:if(e.preventDefault(),u.autocomplete){var a=[],o=t.trim(f.val());if(o.match(/^[^\s]{0,}$/)){for(i in s)""==o?a.push(i):0==i.indexOf(o)&&a.push(i);a.length>1?b(w(),o,'<ul class="sq-li"><li>'+a.join("</li><li>")+"</li></ul>"):1==a.length&&f.val(a.pop()+" ")}}T();break;case 38:e.preventDefault(),u.history&&(r=null===r||0==r?l.length-1:r-1,f.val(l[r]));break;case 40:if(e.preventDefault(),u.history){if(null===r||r==l.length-1){f.val("");break}r++,f.val(l[r])}break;case 13:e.preventDefault(),p.submit(),T(),f.focus()}}),_.keydown(function(t){if(_.is(":visible")){var e=t.keyCode;switch(e){case 13:t.preventDefault(),p.submit(),_.hide(),f.show(),T(),f.focus()}}}),t(document).keydown(function(t){var e=t.keyCode;switch(e){case 27:f.is(":visible")?f.focus():_.is(":visible")&&_.focus()}})})},t.register_command=function(t,e,n,a){var l=!1;return("string"==typeof a||"object"==typeof a||"function"==typeof a)&&(s[t]={desc:e,usage:n,type_of:a},l=!0),l},t.register_callback=function(t,e){var n=!1;return("string"==typeof e||"object"==typeof e||"function"==typeof e)&&(a[t]=e,n=!0),n},t.flush_commands=function(e){s={},t.set_command_option(e),c(e)},t.set_command_option=function(e){t.extend(!0,o,e)},t.get_command_option=function(t){var e={};for(opt in t)"undefined"!=typeof o[opt]&&(e[opt]=o[opt]);return e}}(jQuery);